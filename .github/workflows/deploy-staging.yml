name: Deploy to Staging (TestFlight/Internal Testing)

permissions:
  contents: write  # Allow pushing tags
  packages: write  # Allow publishing to GitHub Packages (for release-shared workflow)

on:
  # Trigger on staging tags (e.g., v1.8.0-beta.1) or push to develop branch
  push:
    tags:
      - 'v*-beta.*'
      - 'v*-rc.*'
    branches:
      - develop
  
  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy (ios, android, all)'
        required: true
        default: 'all'
        type: choice
        options:
          - ios
          - android
          - all

# Prevent concurrent deployments - cancel in-progress runs when new one starts
concurrency:
  group: staging-deployment
  cancel-in-progress: true

jobs:
  test:
    name: Run Tests
    uses: ./.github/workflows/test.yml
  
  release-shared:
    name: Release Shared Package
    needs: [test]
    # Only run on develop branch pushes (not on tags or manual triggers)
    # and only if tests passed
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/develop' &&
      needs.test.result == 'success'
    uses: ./.github/workflows/release-shared.yml
    secrets: inherit
  
  update-dependencies:
    name: Update Package Dependencies
    needs: [release-shared]
    # Only run if release-shared succeeded (new version published)
    if: needs.release-shared.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull latest changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git pull origin develop
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@jbuxofplenty'
      
      - name: Setup GitHub Packages
        uses: ./.github/actions/setup-github-packages
      
      - name: Update shared package version
        run: |
          echo "ðŸ“¦ Upgrading @jbuxofplenty/coral-clash to latest..."
          
          # Update root package
          yarn upgrade @jbuxofplenty/coral-clash --latest
          
          # Update functions package
          cd functions
          yarn upgrade @jbuxofplenty/coral-clash --latest
          cd ..
          
          # Ensure shared package lockfile is up to date (for build dependencies)
          cd shared
          yarn install --check-files
          cd ..
          
          echo "âœ… Dependencies updated"
      
      - name: Commit updated lockfiles
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Verify we're on develop branch
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if [ "$CURRENT_BRANCH" != "develop" ]; then
            echo "âŒ Error: Not on develop branch (current: $CURRENT_BRANCH)"
            exit 1
          fi
          echo "âœ… Confirmed on develop branch"
          
          # Check if there are changes to commit (any of the three lockfiles)
          if git diff --quiet yarn.lock functions/yarn.lock shared/yarn.lock; then
            echo "No lockfile changes to commit"
            exit 0
          fi
          
          # Pull latest changes with autostash (semantic-release may have pushed)
          echo "ðŸ”„ Pulling latest from develop with autostash..."
          git pull --rebase --autostash origin develop
          
          # Stage and commit all lockfiles
          echo "ðŸ“ Committing lockfile updates..."
          git add yarn.lock functions/yarn.lock shared/yarn.lock
          git commit -m "chore(deps): update @jbuxofplenty/coral-clash to latest [skip ci]"
          
          # Push and verify success
          echo "ðŸ“¤ Pushing to develop..."
          if git push origin develop; then
            echo "âœ… Lockfiles updated and pushed successfully"
          else
            echo "âŒ Failed to push lockfile updates to develop"
            exit 1
          fi
  
  deploy-staging:
    name: Deploy to Staging
    needs: [test, release-shared, update-dependencies]
    # Run after test succeeds, and either:
    # - release-shared succeeded and update-dependencies succeeded, OR
    # - release-shared was skipped
    if: |
      !cancelled() && 
      needs.test.result == 'success' && 
      (
        (needs.release-shared.result == 'success' && needs.update-dependencies.result == 'success') ||
        needs.release-shared.result == 'skipped'
      )
    uses: ./.github/workflows/build-and-submit.yml
    with:
      profile: 'preview'
      platform: ${{ github.event.inputs.platform || 'all' }}
      environment: 'staging'
    secrets: inherit
  
  deploy-firebase:
    name: Deploy Firebase Functions
    needs: deploy-staging
    uses: ./.github/workflows/firebase-deploy.yml
    with:
      target: 'all'
    secrets:
      FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
  
  promote-gate:
    name: Approve for Production
    needs: [deploy-staging, deploy-firebase]
    runs-on: ubuntu-latest
    environment:
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    outputs:
      staging_tag: ${{ steps.extract.outputs.staging_tag }}
      should_promote: ${{ steps.extract.outputs.should_promote }}
      is_branch: ${{ steps.extract.outputs.is_branch }}
      platform: ${{ steps.platform.outputs.platform }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract platform selection
        id: platform
        run: |
          # Get platform from manual trigger or default to 'all'
          PLATFORM="${{ github.event.inputs.platform || 'all' }}"
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
          echo "ðŸ“± Platform: $PLATFORM"
      
      - name: Determine staging tag
        id: extract
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag-based deployment
            STAGING_TAG="${GITHUB_REF#refs/tags/}"
            echo "is_branch=false" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸  Using existing staging tag: $STAGING_TAG"
          else
            # Branch-based deployment - use latest beta/rc tag
            echo "is_branch=true" >> $GITHUB_OUTPUT
            
            # Get the latest beta/rc tag
            LATEST_STAGING_TAG=$(git tag -l 'v*' | grep -E '(beta|rc)' | sort -V | tail -n1)
            
            if [ -z "$LATEST_STAGING_TAG" ]; then
              # No existing staging tags, start at v1.0.0-beta.1
              STAGING_TAG="v1.0.0-beta.1"
              echo "ðŸ†• No existing staging tags found - creating initial tag: $STAGING_TAG"
            else
              # Use the latest staging tag
              STAGING_TAG="$LATEST_STAGING_TAG"
              echo "ðŸ“Š Using latest staging tag: $STAGING_TAG"
            fi
          fi
          
          echo "staging_tag=$STAGING_TAG" >> $GITHUB_OUTPUT
          echo "should_promote=true" >> $GITHUB_OUTPUT
      
      - name: Create staging tag for branch deployment
        if: steps.extract.outputs.is_branch == 'true'
        run: |
          STAGING_TAG="${{ steps.extract.outputs.staging_tag }}"
          
          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Check if tag already exists
          if git rev-parse "$STAGING_TAG" >/dev/null 2>&1; then
            echo "âš ï¸  Tag $STAGING_TAG already exists - skipping creation"
            echo "â„¹ï¸  Will use existing tag for deployment"
          else
            # Create and push staging tag
            git tag -a "$STAGING_TAG" -m "Auto-generated staging tag from ${{ github.ref_name }}"
            git push origin "$STAGING_TAG"
            echo "âœ… Created staging tag: $STAGING_TAG"
          fi
      
      - name: Ready to promote
        run: |
          echo "### âœ… Staging Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.extract.outputs.is_branch }}" = "true" ]; then
            echo "Branch **${{ github.ref_name }}** has been deployed to TestFlight." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Auto-generated staging tag: **${{ steps.extract.outputs.staging_tag }}**" >> $GITHUB_STEP_SUMMARY
          else
            echo "Staging tag **${{ steps.extract.outputs.staging_tag }}** has been deployed to TestFlight." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Staging Platform**: ${{ steps.platform.outputs.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§ª **Test the staging build**, then approve this step to promote to production." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Production tag will be: **$(echo ${{ steps.extract.outputs.staging_tag }} | sed -E 's/-beta\.[0-9]+$//' | sed -E 's/-rc\.[0-9]+$//')**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± _Production will deploy to **all platforms** (iOS + Android)_" >> $GITHUB_STEP_SUMMARY
  
  sync-to-main:
    name: Sync develop to main
    needs: [deploy-firebase]
    # Only run on develop branch pushes after successful deployment
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/develop' &&
      needs.deploy-firebase.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Merge develop to main
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Fetch main branch
          git fetch origin main
          
          # Checkout main
          git checkout main
          git pull origin main
          
          # Merge develop
          echo "ðŸ”€ Merging develop into main..."
          git merge origin/develop --no-ff -m "chore: sync develop to main after successful staging deployment [skip ci]"
          
          # Push to main
          git push origin main
          
          echo "âœ… Successfully synced develop to main"
      
      - name: Summary
        run: |
          echo "### âœ… Branches Synced" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**develop** â†’ **main** merge complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Both branches are now in sync after successful deployment." >> $GITHUB_STEP_SUMMARY
  
  promote-to-production:
    name: Promote to Production
    needs: promote-gate
    if: needs.promote-gate.outputs.should_promote == 'true'
    uses: ./.github/workflows/promote-to-production.yml
    with:
      staging_tag: ${{ needs.promote-gate.outputs.staging_tag }}
    secrets: inherit
