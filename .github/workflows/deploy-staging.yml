name: Deploy to Staging (TestFlight/Internal Testing)

on:
  # Trigger on staging tags (e.g., v1.8.0-beta.1) or push to develop branch
  push:
    tags:
      - 'v*-beta.*'
      - 'v*-rc.*'
    branches:
      - develop
  
  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy (ios, android, all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - android

jobs:
  deploy-staging:
    name: Deploy to Staging
    uses: ./.github/workflows/build-and-submit.yml
    with:
      profile: 'preview'
      platform: ${{ github.event.inputs.platform || 'all' }}
      environment: 'staging'
    secrets:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  
  promote-gate:
    name: Approve for Production
    needs: deploy-staging
    runs-on: ubuntu-latest
    # Only run for tag-based deployments, not branch pushes
    if: startsWith(github.ref, 'refs/tags/') && (contains(github.ref, '-beta.') || contains(github.ref, '-rc.'))
    environment:
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    outputs:
      staging_tag: ${{ steps.extract.outputs.staging_tag }}
      should_promote: ${{ steps.extract.outputs.should_promote }}
    
    steps:
      - name: Extract staging tag
        id: extract
        run: |
          # Extract tag name from ref (refs/tags/v1.8.0-beta.1 -> v1.8.0-beta.1)
          STAGING_TAG="${GITHUB_REF#refs/tags/}"
          echo "staging_tag=$STAGING_TAG" >> $GITHUB_OUTPUT
          echo "should_promote=true" >> $GITHUB_OUTPUT
          echo "🏷️  Staging tag: $STAGING_TAG"
      
      - name: Ready to promote
        run: |
          echo "### ✅ Staging Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Staging tag **${{ steps.extract.outputs.staging_tag }}** has been deployed to TestFlight." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🧪 **Test the staging build**, then approve this step to promote to production." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Production tag will be: **$(echo ${{ steps.extract.outputs.staging_tag }} | sed -E 's/-beta\.[0-9]+$//' | sed -E 's/-rc\.[0-9]+$//')**" >> $GITHUB_STEP_SUMMARY
  
  promote-to-production:
    name: Promote to Production
    needs: promote-gate
    if: needs.promote-gate.outputs.should_promote == 'true'
    uses: ./.github/workflows/promote-to-production.yml
    with:
      staging_tag: ${{ needs.promote-gate.outputs.staging_tag }}
      platform: 'all'
    secrets: inherit

