# Cursor AI Rules for Coral Clash

## Git Commit Guidelines

- ALWAYS use conventional commit format: `<type>(<scope>): <subject>`
- Valid types: feat, fix, docs, refactor, test, ci, chore, build, perf, style
- Valid scopes:
    - `shared` - Changes to game engine (@jbuxofplenty/coral-clash package)
    - `client` - Frontend/React Native changes
    - `server` - Backend/Firebase Functions changes
    - `ci` - CI/CD workflow changes
    - `docs` - Documentation only changes
- Examples:
    - `feat(shared): add whale rotation validation`
    - `fix(shared): correct coral placement logic`
    - `feat(client): add version warning banner`
    - `fix(server): handle timeout edge cases`
    - `docs(deployment): add approval setup guide`
    - `refactor(ci): simplify platform selection logic`

## Semantic Versioning System

- Game engine (`@jbuxofplenty/coral-clash`) uses semantic versioning (semver.org)
- Version bumps are AUTOMATIC based on conventional commit messages:
    - `feat(shared):` → MINOR version bump (1.0.0 → 1.1.0) - new features
    - `fix(shared):` → PATCH version bump (1.0.0 → 1.0.1) - bug fixes
    - `feat(shared)!:` or `BREAKING CHANGE:` → MAJOR version bump (1.0.0 → 2.0.0) - breaking changes
- Version is managed by semantic-release in CI/CD pipeline
- NEVER manually edit version in `shared/package.json` (managed by semantic-release)
- Package is automatically published to GitHub Packages on push to develop
- Both client and server MUST use the same published version of @jbuxofplenty/coral-clash
- Version validation happens server-side - clients with outdated versions get warnings

### Version Compatibility Rules

- Major versions must match (breaking changes)
- Minor versions must match (new features)
- Patch versions can differ (bug fixes are compatible)

### When Making Changes to Game Engine

- Always use `shared` scope in commits: `feat(shared):` or `fix(shared):`
- Be intentional about breaking changes - use `!` or `BREAKING CHANGE:` footer
- Test changes thoroughly - version bumps trigger automatic deployment
- Changes to `shared/game/` will trigger new package release

## Backend API Changes (Firebase Functions)

- Always make API schema changes backwards compatible (API released before client)
- **Deployment Order**: Deploy API changes BEFORE client updates that depend on them
  - This ensures old clients continue working while new clients can use new features
  - Use feature flags or version checks to enable new functionality gradually
- **Schema Evolution Patterns**:
  - Add new fields as optional (never remove existing fields)
  - Support multiple response formats based on client version when needed
  - Use version parameters (`clientVersion`) to determine response format
  - Deprecate fields by marking them optional and documenting removal timeline
- **Error Handling**:
  - Always use Firebase `HttpsError` with appropriate error codes (`unauthenticated`, `permission-denied`, `not-found`, `invalid-argument`, `already-exists`, `internal`)
  - Provide clear, actionable error messages
  - Never expose internal implementation details in error messages
  - Log detailed errors server-side for debugging
- **Input Validation**:
  - Validate all inputs at the API boundary
  - Use version validation (`validateClientVersion`) for game engine compatibility
  - Validate required fields and data types before processing
  - Return `invalid-argument` errors for validation failures
- **Testing Requirements**:
  - Write tests for all API endpoints (use handler functions separated from exports)
  - Test backwards compatibility with old client versions
  - Test error cases and edge cases
  - Test authentication and authorization scenarios
- **Documentation**:
  - Document API changes in commit messages using `feat(server):` or `fix(server):` scope
  - Update API documentation when adding new endpoints or changing schemas
  - Document breaking changes explicitly (should be rare due to backwards compatibility)

## Git Operations

- NEVER run `git commit/push` unless explicitly requested by the user
- Ask for confirmation before force pushing or destructive git operations

## Firebase Development

- NEVER restart Firebase emulators unless explicitly requested
- NEVER stop running Firebase emulators automatically
- Keep emulators running in the background
- Always add tests to functions (i.e. routes, triggers, scheduled funcs)

## Development Workflow

- Run tests before suggesting deployment
- Use iOS as default platform (until Android setup is complete)
- Prefer `yarn` over `npm` for package management

### Working with Shared Package Locally

- For local development with unpublished changes to `@jbuxofplenty/coral-clash`:
    - In functions: `cd functions && yarn dev:link`
    - In client: `yarn dev:link`
- When done testing, unlink: `yarn dev:unlink` (then reinstall from registry)
- NEVER commit with local linked version - always use published package
- If making changes to game engine, expect a new package version to be published on push

## Code Quality

- Follow existing code style and patterns in the repository
- Use TypeScript types when working with shared module
- Keep functions focused and single-purpose
- Always add tests for BE related code (not react components atm)

## Testing

- **ALWAYS** load a fixture or use INITIAL_STATE when writing tests for game logic
- Never test with an empty board state unless explicitly testing initialization
- Use `applyFixture(game, fixture)` for complex game states
- Use `game.load(fen)` for simple board setups
- Create fixtures in `shared/game/__fixtures__/` for reusable test scenarios
- All tests must pass before committing - remove or fix failing tests
- When running tests on the coralClash.ts game engine, you need to execute the `yarn test` command from the `shared` directory
- For UI related tests, run from the root of the repo

## Documentation

- Update relevant documentation when making significant changes
- Include examples in documentation
- Keep docs concise and actionable

## Build & Deployment

- Use Fastlane for building and submitting apps (iOS & Android)
- Use `npx expo prebuild` to generate native directories
- Never commit generated `ios/` or `android/` directories
- Game engine version bumping is AUTOMATIC via semantic-release (see Semantic Versioning System)
- Deployment workflow: Release shared package → Deploy apps → Deploy Firebase functions
- iOS builds require Fastlane Match for code signing
- Android builds require keystore (never commit `.keystore` files)
- Both client and server pull @jbuxofplenty/coral-clash from GitHub Packages (not local files)

## Communication

- Be concise but thorough in explanations
- Show what changed and why it matters
- Provide examples when introducing new patterns
- Add documentation markdown file to docs folder for complex features/architecture
